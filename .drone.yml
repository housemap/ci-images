kind: pipeline
type: docker
name: dind

steps:
- name: build
  image: docker:dind
  environment:
    DOCKER_USERNAME:
      from_secret: docker_username
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_HOST: tcp://127.0.0.1:2376
  commands:
  - DOCKER_USERNAME=$DOCKER_USERNAME DOCKER_PASSWORD=$DOCKER_PASSWORD sh build_deploy.sh
  when:
    branch:
    - master

services:
  - name: docker
    image: docker:dind
    privileged: true
    command: [ --storage-driver=overlay2]